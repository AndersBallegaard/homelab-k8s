<!doctype html>
<html lang="en">

<head>
        <title>Overview - K8S homelab</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        <link rel="canonical" href="https://homelab.anderstb.dk/infra/networking/overview/">
        <meta name="author" content="Anders Ballegaard">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="../../../assets/css/darcula-highlight.min.css">

        <link rel="stylesheet" href="../../../assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="../../../assets/css/dracula-ui.min.css">
        <link rel="stylesheet" href="../../../assets/css/mkdocs.min.css">

        
            <link  rel="icon" type="image/x-icon" href="../../../assets/img/favicon.ico">
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/hcl.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/go.min.js"></script>
                <script>hljs.initHighlightingOnLoad();</script>

</head>

<body class="drac-bg-black-secondary drac-text-grey-ternary drac-text drac-scrollbar-purple">

    <main class="d-flex">

        <!-- block sidebar -->
            <nav id="sidebar" class="sidebar drac-bg-black">
    <div class="custom-menu">
        <button type="button" id="sidebarCollapse" class="btn btn-primary">
            <i class="fa fa-bars"></i>
            <span class="sr-only">Menu</span>
        </button>
    </div>

    <div class="p-4">
        

        <div class="drac-text-center">
            
                <span class="drac-text drac-line-height drac-text-white">K8S homelab</span>
            
        </div>

        <div class="drac-box flex-column">
            <ul class="dot-ul">
                <li><div class="dot-li drac-bg-cyan"></div></li>
                <li><div class="dot-li drac-bg-green"></div></li>
                <li><div class="dot-li drac-bg-orange"></div></li>
                <li><div class="dot-li drac-bg-pink"></div></li>
                <li><div class="dot-li drac-bg-purple"></div></li>
                <li><div class="dot-li drac-bg-red"></div></li>
                <li><div class="dot-li drac-bg-yellow"></div></li>
            </ul>
        </div>

        <hr class="drac-divider" />

        <!-- block menu -->
        <ul class="mb-5 drac-list drac-list-none">
            
            <li class="drac-box">
                <a href="../../.."
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Home
                </a>
            </li>
            <li class="drac-box">
                <a href="../../.."
                    class=" active 
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#infrastructure-collapse" aria-expanded="false">
                    Infrastructure
                </a>
                <div class="collapse" id="infrastructure-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="#" class="
            drac-anchor-secondary btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
            data-bs-toggle="collapse" data-bs-target="#deployment-collapse" aria-expanded="false">
            Deployment
        </a>

        <div class="collapse" id="deployment-collapse">
            <ul class="mb-5 drac-list drac-list-none">
                    
    <li class="drac-box-ternary">
        <a href="../../deployment/prepare_admin_node/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Prepare admin node
        </a>
    </li>
                    
    <li class="drac-box-ternary">
        <a href="../../deployment/prepare_proxmox/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Prepare proxmox
        </a>
    </li>
                    
    <li class="drac-box-ternary">
        <a href="../../deployment/setup_cluster/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Setup cluster
        </a>
    </li>
            </ul>
        </div>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="#" class="
            drac-anchor-secondary btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
            data-bs-toggle="collapse" data-bs-target="#networking-collapse" aria-expanded="false">
            Networking
        </a>

        <div class="collapse" id="networking-collapse">
            <ul class="mb-5 drac-list drac-list-none">
                    
    <li class="drac-box-ternary">
        <a href="./"
            class=" active 
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Overview
        </a>
    </li>
                    
    <li class="drac-box-ternary">
        <a href="../vyos/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            VYOS Configuration
        </a>
    </li>
            </ul>
        </div>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../conformance_testing/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Conformance testing
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../fluxcd/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            FluxCD
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../kubernetes/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            K8S
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../../traefik/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Traefik
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../../../apps/apps/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Apps
                </a>
            </li>
            <li class="drac-box">
                <a href="../../.."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#troubleshooting-collapse" aria-expanded="false">
                    Troubleshooting
                </a>
                <div class="collapse" id="troubleshooting-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../../../troubleshooting/port-forwarding/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            K8S Port forwarding
        </a>
    </li>
                    </ul>
                </div>
            </li>
            <li class="drac-box">
                <a href="../../.."
                    class="
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#information-collapse" aria-expanded="false">
                    Information
                </a>
                <div class="collapse" id="information-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../../../info/docs/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Documentation
        </a>
    </li>
                    </ul>
                </div>
            </li>
        </ul>
        <!-- endblock -->
    </div>
</nav>
        <!-- endblock -->

        <nav class="divider drac-bg-purple-cyan"></nav>

        <div class="content">
            <!-- block header -->
                <header>
    <nav class="navbar navbar-expand-xl drac-bg-purple">
        <div class="container-fluid">
            
            <button class="navbar-toggler w-100 text-center" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
                aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
                <ul class="navbar-nav text-md-center">

                    <!-- block preview -->
                    <li class="nav-item">
                            
        <div class="container">
            <div class="row row-preview">
                <div class="col">
                    <a href="../../deployment/setup_cluster/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </div>
                <div class="col">
                    <a href="../vyos/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover" style="padding-left: 3%;">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
                    </li>
                    <!--  endblock -->

                    <!-- block search -->
                    <li class="nav-item"><div role="search" class="search-box">
	<form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
		<input type="text" name="q" class="drac-input drac-input-search drac-input-white drac-text-white drac-bg-black-secondary"
		placeholder="Search docs" title="Type search term here" />
	</form>
</div>
                    </li>
                    <!--  endblock -->

                    <!-- block source -->
                    <li class="nav-item">
                        
                            
                        
                    </li>
                    <!--  endblock -->

                </ul>
            </div>

        </div>
    </nav>
</header>
            <!-- endblock -->

            <!-- block content -->
                <section class="p-md-5 section-content">
    <article>
        <p><h1 id="overview">Overview</h1>
<p>The kubernetes lab uses Cilium as the CNI, in this deployment Cilium is running IPv6 only in native-routing mode with BGP peerings to two virtual VYOS routers acting as essentially a mix between TOR switches and a CE router for my personal ASN AS201911.</p>
<p>Cilium was chosen as the CNI due to the following reasons
- Excelent BGP support
- Interesting observability tools though Hubble
- High performance due to eBPF
- Great support for network policies
- Support for advanced networking features i might want to checkout like srv6 in k8s
- Built in gateway API and ingress</p>
<p>See diagram below for a vistual representation</p>
<p><img alt="Network diagram for k8s homelab" src="../assets/network-diagram.png" title="Network diagram" /></p>
<h2 id="addressing">Addressing</h2>
<p>Due to running IPv6 only in my own ASN, i have assigned a /48 network to this k8s lab.</p>
<p>Some of the plan looks the way it does due to previously being part of a shared /48 network with other lab infra, cleaning up the IP plan is todo point for a time where the cluster is down anyways.</p>
<p>The addressing plan looks as follows</p>
<table>
<thead>
<tr>
<th>Prefix</th>
<th>Location</th>
<th>Use</th>
</tr>
</thead>
<tbody>
<tr>
<td>2a0e:97c0:ae3::/48</td>
<td>Lab</td>
<td>Assigned Aggregate</td>
</tr>
<tr>
<td>2a0e:97c0:ae3:c100::/112</td>
<td>Cluster</td>
<td>K8S Service subnet</td>
</tr>
<tr>
<td>2a0e:97c0:ae3:c200::/56</td>
<td>Cluster</td>
<td>K8S PodCIDR</td>
</tr>
<tr>
<td>2a0e:97c0:ae3:c401::/64</td>
<td>Cluster</td>
<td>K8S Cilium LB IP pool</td>
</tr>
<tr>
<td>2a0e:97c0:ae3:fff0::/64</td>
<td>Vlan 2502 - K8S Node network</td>
<td>Node IP's</td>
</tr>
<tr>
<td>2a0e:97c0:ae3:ffff::/64</td>
<td>Loopback aggregates</td>
<td>Assigned Aggregate</td>
</tr>
<tr>
<td>2a0e:97c0:ae3:ffff::1/128</td>
<td>r01.k8s.srv6.dk</td>
<td>MGMT Loopback</td>
</tr>
<tr>
<td>2a0e:97c0:ae3:ffff::2/128</td>
<td>r02.k8s.srv6.dk</td>
<td>MGMT Loopback</td>
</tr>
</tbody>
</table>
<h2 id="cilium-configuration">Cilium configuration</h2>
<p>Cilium is installed doing setup of the cluster, for more information about that see <a href="../../deployment/setup_cluster/">Cluster setup</a> and <a href="https://github.com/AndersBallegaard/homelab-k8s/blob/main/admin/patch_infra.sh">patch_infra.sh script</a></p>
<p>For configuration related parameters, I am using a kustomization deployed by fluxcd to manage it. This choice have been made in order to have as much declaritive, easy to manage configuration as posible.</p>
<h3 id="loadbalancer-pools">Loadbalancer pools</h3>
<p>The cluster needs external IP's to assign to any service of the type loadBalancer, given i have an ipv6 only cluster with my own address space, the most obivious choice was to use global ipv6 in this case, but you can absolutly find other solutions if that's not posible for your setup.</p>
<pre><code class="language-yaml"># cluster/infra/cilium/lb-ipam.yaml
apiVersion: &quot;cilium.io/v2alpha1&quot;
kind: CiliumLoadBalancerIPPool
metadata:
  name: &quot;lb-pool&quot;
spec:
  blocks:
  - cidr: &quot;2a0e:97c0:ae3:c401::/64&quot;
</code></pre>
<h3 id="bgp-configuration">BGP Configuration</h3>
<p>Let's look at the general BGP setup.
There is quite a lot going on here, but in it basicly just does the following
* Creates a BGP "Cluster" called cilium-bgp, and provisions it on all nodes
* Specifies that the local-as is 65500
* Sets up peerings to R01.k8s.srv6.dk and R02.k8s.srv6.dk
* Creates a CiliumBGPPeerConfig (Peer group) specifying that ipv6 unicast is the only family enabled, and setting a password</p>
<pre><code class="language-yaml"># cluster/infra/cilium/bgp.yaml
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPClusterConfig
metadata:
  name: cilium-bgp
  namespace: kube-system
spec:
  nodeSelector:
    matchLabels:
      kubernetes.io/os: linux
  bgpInstances:
  - name: &quot;instance-65500&quot;
    localASN: 65500
    peers:
    - name: &quot;r01&quot;
      peerASN: 65666
      peerAddress: 2a0e:97c0:ae3:fff0::1
      peerConfigRef:
        name: &quot;cilium-peer&quot;
    - name: &quot;r02&quot;
      peerASN: 65666
      peerAddress: 2a0e:97c0:ae3:fff0::2
      peerConfigRef:
        name: &quot;cilium-peer&quot;

---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPPeerConfig
metadata:
  name: cilium-peer
  namespace: kube-system
spec:
  authSecretRef: bgp-auth-secret
  timers:
    holdTimeSeconds: 9
    keepAliveTimeSeconds: 3
  ebgpMultihop: 4
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 15
  families:
    - afi: ipv6
      safi: unicast
      advertisements:
        matchLabels:
          advertise: bgp
</code></pre>
<p>NOTE: This uses the BGP secret set during cluster setup, please make sure the password accually matches.</p>
<p>NOTE: Under cluster setup <strong>anotate-nodes.sh</strong> was executed in the background, this script sets router-id's on a list of nodes. If some nodes won't peer check that a router-id have been set</p>
<h3 id="create-annoncements">Create annoncements</h3>
<p>Ok, we are not quite done with the BGP configuration, we still needs to specify what to announce. </p>
<p>In my example due to running cilium in native-routing mode, i want to advertise everything i know. For this reason i am creating two CiliumBGPAdvertisement objects bellow advertising the following</p>
<ul>
<li>ExternalIP</li>
<li>LoadBalancerIP</li>
<li>ClusterIP</li>
<li>PodCIDR</li>
</ul>
<pre><code class="language-yaml"># cluster/infra/cilium/advertisements.yaml
---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPAdvertisement
metadata:
  labels:
    advertise: bgp
  name: bgp-advertisements
spec:
  advertisements:
  - advertisementType: Service
    selector:
      matchExpressions:
      - key: somekey  # For some reason this works, and things break if i remove it, no this key does not exist anywhere
        operator: NotIn
        values:
        - never-used-value
    service:
      addresses:
      - ExternalIP
      - LoadBalancerIP
      - ClusterIP
---
apiVersion: cilium.io/v2alpha1
kind: CiliumBGPAdvertisement
metadata:
  name: bgp-advertisements-podcidr
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: &quot;PodCIDR&quot;
      attributes:
        communities:
          standard: [ &quot;65000:99&quot; ]
        localPreference: 99
</code></pre>
<h3 id="building-the-kustomization">Building the kustomization</h3>
<p>Let's put it all togther in a simple kustomization</p>
<pre><code class="language-yaml"># cluster/infra/cilium/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
metadata:
  name: cillium-config
resources:
  - lb-ipam.yaml
  - bgp.yaml
  - advertisements.yaml
</code></pre>
<h2 id="router-configuration">Router configuration</h2>
<p>See <a href="../vyos/">VYOS Configuration</a></p>
<hr />
<p>This page is autogenerated, do not edit it directly <a href="https://homelab.anderstb.dk/info/docs/">see this for more information</a></p></p>
    </article>
</section>
            <!-- endblock -->

            <!-- block footer -->
                <footer>
    <div class="d-flex flex-sm-row justify-content-between py-2 border-top drac-text-black drac-bg-cyan-green">
        <a href="https://github.com/dracula/mkdocs" target="_blank" style="padding-left: 1%;"
            class="footer-text drac-anchor drac-text-black drac-text-purple--hover">
            Made with Dracula Theme for MkDocs
        </a>
    </div>
</footer>
            <!-- endblock -->
        </div>

    </main>

        <script>var base_url = '../../..';</script>
        <script src="../../../assets/js/jquery-3.3.1.slim.min.js"></script>
        <script src="../../../assets/js/bootstrap.bundle.min.js"></script>
        <script src="../../../assets/js/mkdocs.js"></script>
			<script src="../../../search/main.js" defer></script>

</body>

</html>